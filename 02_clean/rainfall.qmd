
```{python}
import cdsapi
import xarray as xr
# import scipy.io.netcdf as S
# from scipy.io import netcdf
import pandas as pd
import numpy as np

from pyprojroot.here import here

import ee

import folium
from folium import plugins
import geemap.foliumap as geemap

```


```{python}
# 1. Download data from ERA5-Land (Copernicus API)
client = cdsapi.Client()

dataset = "reanalysis-era5-land"
request = {
    "variable": ["total_precipitation"],
    "year": "2017",
    "month": "07",
    "day": [
        "01", "02", "03",
        "04", "05", "06",
        "07", "08", "09",
        "10", "11", "12",
        "13", "14", "15",
        "16", "17", "18",
        "19", "20", "21",
        "22", "23", "24",
        "25", "26", "27",
        "28", "29", "30",
        "31"
    ],
    # "day": [f"{d:02d}" for d in range(1, 32)],
    "time": [f"{h:02d}:00" for h in range(24)],  # 00:00-23:00
    # "time": ["09:00"],
    "data_format": "netcdf",
    "download_format": "unarchived",
    "area": [8.7, -13.4, 8, -12.9]
}

client.retrieve(dataset, request).download()
```


```{python}
# 2. Read and daily accumulation
# ds = xr.open_dataset('../01.data/precipitation/day/2025_10.nc')
ds = xr.open_dataset(here('01_data/raw/precipitation/day/2025_10.nc'))
prec = ds['tp'] * 1000  # m to mm
# Data is already daily, so resample is not needed
prec_daily = prec
```

```{python}
ds = xr.open_dataset(here('01_data/raw/precipitation/day/2025_10.nc'))
tp = ds["tp"] * 1000.0  # m to mm

# Spatial average within bbox (dimension names may be 'latitude','longitude' depending on data)
tp_mean = tp.mean(dim=["latitude","longitude"])

# Calculate daily total (sum of hourly values)
tp_daily = tp_mean.resample(valid_time="1D").sum()
tp_daily
# Rainy day flag (ignore small values)
rain_day = (tp_daily > 1)  # Consider as rain if >= 1 mm/day

df = pd.DataFrame({
    "date": tp_daily["valid_time"].values,
    "rain_mm_day": tp_daily.values,
    "rain_flag": rain_day.values.astype(int)
})

print(df.head())
```

```{python}
```

```{python}
# 3. Event extraction
threshold = 30  # mm/day
rain = prec_daily.mean(dim=['latitude', 'longitude'])
df = rain.to_dataframe().reset_index().rename(columns={'tp': 'rain_mm'})
```



```{python}

# Assign consecutive rainfall event IDs
df['event'] = (df['rain_mm'] > threshold).astype(int)
df['event_id'] = (df['event'].diff() == 1).cumsum()
df.loc[df['event'] == 0, 'event_id'] = np.nan

# # 4. Output
# events = df[df['event'] == 1].groupby('event_id').agg(
#     start=('time', 'min'),
#     end=('time', 'max'),
#     total_rain=('rain_mm', 'sum')
# ).reset_index(drop=True)

# events.to_csv('freetown_rain_events.csv', index=False)
# print(events.head())
```


```{python}
# sort by rain_mm descending and display
df.sort_values('rain_mm', ascending=False).reset_index(drop=True)
df.sort_values('rain_mm', ascending=True).reset_index(drop=True)
```

# Detect the available days 

```{python}
# Clear existing session
try:
    ee.Reset()
except:
    pass

# 
ee.Initialize()
# ee.Authenticate()

```

```{python}
# Freetown AOI
# aoi = ee.Geometry.Rectangle([-13.3, 8.2, -12.9, 8.5])


aoi = ee.Geometry.Polygon([
    [
        [-13.3, 8.4],
        [-13.15, 8.4],
        [-13.15, 8.5],
        [-13.3, 8.5],
        [-13.3, 8.4]
    ]
])


```

```{python}
def s1_ic(start, end):
    ic = (ee.ImageCollection('COPERNICUS/S1_GRD')
            .filterBounds(aoi)
            .filterDate(start, end)
            .filter(ee.Filter.eq('instrumentMode','IW'))
            .filter(ee.Filter.listContains('transmitterReceiverPolarisation','VV'))
            .filter(ee.Filter.listContains('transmitterReceiverPolarisation','VH'))
            .select(['VH']))
    
    # Check if any images are found
    size = ic.size().getInfo()
    print(f"Period {start} to {end}: {size} images found")
    
    if size == 0:
        print(f"⚠️  No images found for {start} to {end}")
        return None
    
    return ic
```


```{python}
a = s1_ic('2017-08-14', '2017-08-19')
a
```